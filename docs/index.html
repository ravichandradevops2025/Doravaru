<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doravaru - Live Trading Platform</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-bg: #0a0e1a;
            --secondary-bg: #1a1f2e;
            --card-bg: #252a3a;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-blue: #3742fa;
            --text-primary: #ffffff;
            --text-secondary: #a4a6b3;
            --border-color: #34384a;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #0f1419 100%);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .api-config-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center;
            z-index: 10001;
        }
        .api-config-modal.hidden { display: none; }
        .api-config-content {
            background: var(--card-bg); padding: 30px; border-radius: 15px;
            width: 90%; max-width: 500px; border: 1px solid var(--accent-green);
        }
        .config-input {
            width: 100%; padding: 12px; margin: 8px 0; background: var(--secondary-bg);
            border: 1px solid var(--border-color); border-radius: 6px; color: white;
        }
        .config-btn {
            width: 100%; padding: 12px; background: var(--accent-green);
            color: black; border: none; border-radius: 6px; font-weight: 600;
            cursor: pointer; margin-top: 15px; transition: all 0.3s ease;
        }
        .config-btn:hover { transform: translateY(-2px); }
        .config-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .skip-btn {
            background: var(--border-color); color: white; margin-top: 8px;
        }
        .error-message {
            background: rgba(255, 71, 87, 0.1); border: 1px solid var(--accent-red);
            color: var(--accent-red); padding: 10px; border-radius: 6px; margin: 10px 0;
            font-size: 12px;
        }
        .info-message {
            background: rgba(55, 66, 250, 0.1); border: 1px solid var(--accent-blue);
            color: var(--accent-blue); padding: 10px; border-radius: 6px; margin: 10px 0;
            font-size: 12px;
        }
        .success-message {
            background: rgba(0, 255, 136, 0.1); border: 1px solid var(--accent-green);
            color: var(--accent-green); padding: 10px; border-radius: 6px; margin: 10px 0;
            font-size: 12px;
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-bg); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10000;
            opacity: 1; transition: opacity 0.5s ease;
        }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner {
            width: 50px; height: 50px; border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-green); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .nav-brand h1 {
            font-size: 24px; background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-subtitle { font-size: 12px; color: var(--text-secondary); }
        .nav-status { display: flex; gap: 20px; align-items: center; }
        .status-indicator { display: flex; align-items: center; gap: 8px; }
        .status-dot { 
            width: 8px; height: 8px; border-radius: 50%; 
            background: var(--accent-green); animation: pulse 2s infinite; 
        }
        .status-dot.disconnected { background: var(--accent-red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .market-time { font-weight: 600; color: var(--accent-green); }

        .api-status-badge {
            position: fixed; top: 90px; right: 20px; padding: 8px 12px;
            border-radius: 6px; font-size: 12px; font-weight: 600; z-index: 1000;
        }
        .api-status-badge.live { background: var(--accent-green); color: black; }
        .api-status-badge.demo { background: var(--accent-red); color: white; }

        .platform-container {
            display: grid; grid-template-columns: 280px 1fr 300px;
            min-height: calc(100vh - 80px); gap: 1px; background: var(--border-color);
        }
        .sidebar, .right-panel { background: var(--secondary-bg); padding: 20px; overflow-y: auto; }
        .main-content { background: var(--secondary-bg); display: flex; flex-direction: column; }

        .symbol-card {
            padding: 12px; background: var(--card-bg); border-radius: 8px;
            cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent;
            margin-bottom: 8px;
        }
        .symbol-card:hover { border-color: var(--accent-green); transform: translateX(2px); }
        .symbol-card.active { border-color: var(--accent-green); background: rgba(0, 255, 136, 0.05); }
        .symbol-name { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .symbol-price { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .symbol-change { font-size: 12px; font-weight: 500; }
        .symbol-change.positive { color: var(--accent-green); }
        .symbol-change.negative { color: var(--accent-red); }

        .chart-section { 
            flex: 1; display: flex; flex-direction: column; padding: 20px; 
            min-height: 500px;
        }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-container { 
            flex: 1; background: var(--card-bg); border-radius: 8px; 
            padding: 20px; margin-bottom: 20px; position: relative;
            min-height: 400px;
        }
        #tradingChart { width: 100%; height: 100%; }

        .price-bar {
            display: flex; align-items: center; gap: 20px; padding: 15px 0;
            border-top: 1px solid var(--border-color);
        }
        .current-price { font-size: 24px; font-weight: 700; }
        .price-change { font-size: 14px; font-weight: 600; }
        .price-change.positive { color: var(--accent-green); }
        .price-change.negative { color: var(--accent-red); }

        .analysis-section {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; 
            padding: 0 20px 20px; min-height: 300px;
        }
        .technical-indicators, .signal-generator {
            background: var(--card-bg); padding: 20px; border-radius: 8px;
        }
        .indicators-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .indicator { display: flex; flex-direction: column; gap: 5px; }
        .indicator label { font-size: 12px; color: var(--text-secondary); }
        .indicator span { font-weight: 600; }
        .indicator .bullish { color: var(--accent-green); }
        .indicator .bearish { color: var(--accent-red); }
        .indicator .neutral { color: #ffd700; }

        .generate-btn {
            width: 100%; padding: 15px; background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white; border: none; border-radius: 8px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: transform 0.3s ease;
        }
        .generate-btn:hover { transform: translateY(-2px); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .signal-result { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .professional-signal {
            background: rgba(0, 255, 136, 0.1); border-radius: 12px; padding: 20px;
            border: 1px solid var(--accent-green);
        }

        .options-recommendation {
            background: rgba(0, 188, 212, 0.1); padding: 15px; border-radius: 8px;
            margin: 15px 0; border-left: 4px solid var(--accent-blue);
        }

        .depth-table {
            background: var(--card-bg); border-radius: 8px; overflow: hidden; margin-bottom: 30px;
        }
        .depth-header {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;
            padding: 10px; background: var(--primary-bg); font-size: 12px;
            font-weight: 600; color: var(--text-secondary);
        }
        .depth-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;
            padding: 8px 10px; font-size: 12px; border-bottom: 1px solid var(--border-color);
        }

        .news-item {
            padding: 15px; background: var(--card-bg); border-radius: 8px;
            position: relative; margin-bottom: 15px;
        }
        .news-time {
            font-size: 10px; color: var(--text-secondary);
            position: absolute; top: 8px; right: 8px;
        }
        .sentiment {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
        }
        .sentiment.bullish { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .sentiment.live { background: rgba(55, 66, 250, 0.2); color: var(--accent-blue); }
        .sentiment.connected { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }

        .portfolio-metrics { display: flex; flex-direction: column; gap: 12px; }
        .metric { display: flex; justify-content: space-between; align-items: center; }
        .metric label { font-size: 12px; color: var(--text-secondary); }
        .metric .value { font-weight: 600; }
        .metric .value.positive { color: var(--accent-green); }
        .metric .value.negative { color: var(--accent-red); }

        @media (max-width: 1200px) {
            .platform-container { grid-template-columns: 250px 1fr 250px; }
            .analysis-section { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .platform-container { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto 1fr auto;
                height: auto;
            }
            .sidebar, .right-panel { height: auto; }
        }
    </style>
</head>
<body>
    <!-- API Configuration Modal -->
    <div id="apiConfigModal" class="api-config-modal">
        <div class="api-config-content">
            <h3 style="margin-bottom: 20px; color: var(--accent-green);">Angel One API Setup</h3>
            <div class="info-message">
                <strong>Live Data Authentication:</strong><br>
                â€¢ Client Code: Your Angel One login ID (V127611)<br>
                â€¢ TOTP: 6-digit code from Google Authenticator<br>
                â€¢ Make sure API is enabled in Angel One web portal
            </div>
            
            <input type="text" id="clientCode" class="config-input" placeholder="Client Code" value="V127611" />
            <input type="text" id="totp" class="config-input" placeholder="TOTP from Google Authenticator" maxlength="6" />
            
            <div id="authError" class="error-message" style="display: none;"></div>
            <div id="authSuccess" class="success-message" style="display: none;"></div>
            
            <button onclick="connectWithAdvancedAuth()" class="config-btn" id="connectBtn">Connect to Live Data</button>
            <button onclick="useProfessionalDemo()" class="config-btn skip-btn">Use Professional Demo Mode</button>
            
            <div class="info-message">
                <strong>Note:</strong> Due to browser security restrictions, the platform uses an enhanced demo mode that provides realistic market simulation with professional-grade features. This demo includes live-like price movements, technical analysis, and trading signals.
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Initializing Professional Trading Platform...</p>
    </div>

    <div id="apiStatusBadge" class="api-status-badge demo">PROFESSIONAL DEMO</div>

    <nav class="navbar">
        <div class="nav-brand">
            <h1>Doravaru</h1>
            <span class="nav-subtitle">Professional Trading Platform</span>
        </div>
        <div class="nav-status">
            <div class="status-indicator">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText">Initializing...</span>
            </div>
            <div class="market-time" id="market-time">NSE: CHECKING</div>
        </div>
    </nav>

    <div class="platform-container">
        <aside class="sidebar">
            <div class="watchlist-section">
                <h3>Live Watchlist</h3>
                <div id="watchlist">
                    <div class="symbol-card active" data-symbol="NIFTY50" data-token="99926000">
                        <div class="symbol-name">NIFTY 50</div>
                        <div class="symbol-price" id="price-NIFTY50">Loading...</div>
                        <div class="symbol-change" id="change-NIFTY50">--</div>
                    </div>
                    <div class="symbol-card" data-symbol="BANKNIFTY" data-token="99926009">
                        <div class="symbol-name">BANK NIFTY</div>
                        <div class="symbol-price" id="price-BANKNIFTY">Loading...</div>
                        <div class="symbol-change" id="change-BANKNIFTY">--</div>
                    </div>
                    <div class="symbol-card" data-symbol="RELIANCE" data-token="2885">
                        <div class="symbol-name">RELIANCE</div>
                        <div class="symbol-price" id="price-RELIANCE">Loading...</div>
                        <div class="symbol-change" id="change-RELIANCE">--</div>
                    </div>
                    <div class="symbol-card" data-symbol="TCS" data-token="11536">
                        <div class="symbol-name">TCS</div>
                        <div class="symbol-price" id="price-TCS">Loading...</div>
                        <div class="symbol-change" id="change-TCS">--</div>
                    </div>
                </div>
            </div>

            <div class="portfolio-summary" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <h3>Portfolio</h3>
                <div class="portfolio-metrics">
                    <div class="metric">
                        <label>Total Value</label>
                        <span class="value">â‚¹1,00,000</span>
                    </div>
                    <div class="metric">
                        <label>P&L Today</label>
                        <span class="value positive" id="todayPnL">+â‚¹2,450</span>
                    </div>
                    <div class="metric">
                        <label>Available Margin</label>
                        <span class="value">â‚¹97,550</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="chart-section">
                <div class="chart-header">
                    <h2 id="chart-title">NIFTY 50 - Live Chart</h2>
                </div>
                <div class="chart-container">
                    <canvas id="tradingChart" width="800" height="400"></canvas>
                </div>
                <div class="price-bar">
                    <div class="current-price" id="currentPrice">Loading...</div>
                    <div class="price-change" id="priceChange">--</div>
                    <div class="volume">Volume: <span id="volume">--</span></div>
                </div>
            </div>

            <div class="analysis-section">
                <div class="technical-indicators">
                    <h3>Professional Technical Analysis</h3>
                    <div class="indicators-grid">
                        <div class="indicator">
                            <label>RSI (14)</label>
                            <span id="rsi" class="neutral">--</span>
                        </div>
                        <div class="indicator">
                            <label>MACD</label>
                            <span id="macd" class="neutral">--</span>
                        </div>
                        <div class="indicator">
                            <label>SMA 20</label>
                            <span id="sma20">--</span>
                        </div>
                        <div class="indicator">
                            <label>Support</label>
                            <span id="support">--</span>
                        </div>
                        <div class="indicator">
                            <label>Resistance</label>
                            <span id="resistance">--</span>
                        </div>
                    </div>
                </div>

                <div class="signal-generator">
                    <h3>AI Trading Signals & Options</h3>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">
                        Professional-grade analysis with chart annotations and options strategies
                    </p>
                    <button id="generateSignal" class="generate-btn">Generate Professional Signal</button>
                    <div id="signalResult" class="signal-result"></div>
                </div>
            </div>
        </main>

        <aside class="right-panel">
            <div class="market-depth">
                <h3>Market Depth</h3>
                <div class="depth-table">
                    <div class="depth-header">
                        <span>Bid Qty</span>
                        <span>Bid</span>
                        <span>Ask</span>
                        <span>Ask Qty</span>
                    </div>
                    <div id="marketDepth">Loading...</div>
                </div>
            </div>

            <div class="news-feed">
                <h3>Market Feed</h3>
                <div class="news-items">
                    <div class="news-item">
                        <span class="news-time">LIVE</span>
                        <p>Professional platform initialized</p>
                        <span class="sentiment connected">Ready</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Enhanced Angel One Configuration with Better Error Handling
        const ANGEL_ONE_CONFIG = {
            apiKey: 'a18ffda4',
            secretKey: '801865f61-201-46cd-bdb9-b20e64322a2a',
            baseURL: 'https://apiconnect.angelbroking.com'
        };

        // Professional Market Data (Updated with current prices)
        const PROFESSIONAL_MARKET_DATA = {
            'NIFTY50': { price: 25343.78, change: -0.08, token: '99926000', volatility: 0.0012 },
            'BANKNIFTY': { price: 55714.05, change: 0.51, token: '99926009', volatility: 0.0018 },
            'RELIANCE': { price: 1428.40, change: -0.54, token: '2885', volatility: 0.0015 },
            'TCS': { price: 4082.97, change: -0.01, token: '11536', volatility: 0.0010 }
        };

        // Professional Angel One Service with Better Authentication
        class ProfessionalAngelOneService {
            constructor() {
                this.accessToken = null;
                this.isConnected = false;
                this.authAttempts = 0;
                this.maxAttempts = 3;
            }

            async authenticateAdvanced(clientCode, totp) {
                try {
                    this.authAttempts++;
                    console.log(`ðŸ” Authentication attempt ${this.authAttempts}/${this.maxAttempts}`);
                    
                    // Validate inputs
                    if (!clientCode || !totp) {
                        throw new Error('Both Client Code and TOTP are required');
                    }
                    
                    if (!/^[A-Z]\d{6}$/.test(clientCode.trim())) {
                        throw new Error('Client Code should be in format like V127611');
                    }
                    
                    if (!/^\d{6}$/.test(totp.trim())) {
                        throw new Error('TOTP must be exactly 6 digits from Google Authenticator');
                    }

                    // For now, due to CORS restrictions in browsers, we'll use professional demo
                    // In a real production environment, this would need a backend proxy
                    
                    console.log('ðŸŒ Browser environment detected - CORS restrictions apply');
                    console.log('ðŸŽ¯ Activating Professional Demo Mode with realistic market simulation');
                    
                    return this.createProfessionalDemo(clientCode, 'Browser CORS restrictions prevent direct API access');

                } catch (error) {
                    console.error('ðŸ”¥ Authentication error:', error);
                    return {
                        success: false,
                        isDemo: true,
                        message: `Authentication failed: ${error.message}. Using Professional Demo Mode.`,
                        data: { clientCode, demoMode: true, isLive: false }
                    };
                }
            }

            createProfessionalDemo(clientCode, reason) {
                console.log('ðŸŽ­ Creating Professional Demo Mode...');
                
                return {
                    success: false,
                    isDemo: true,
                    message: `${reason}. Professional Demo Mode provides realistic market simulation with all features enabled.`,
                    data: {
                        clientCode: clientCode,
                        demoMode: 'professional',
                        isLive: false,
                        features: ['Real-time price simulation', 'Technical analysis', 'Chart annotations', 'Options strategies']
                    }
                };
            }

            async fetchProfessionalData(symbols) {
                return this.generateProfessionalMarketData(symbols);
            }

            generateProfessionalMarketData(symbols) {
                console.log('ðŸ“Š Generating professional market data...');
                return symbols.map(symbol => this.generateProfessionalSymbolData(symbol));
            }

            generateProfessionalSymbolData(symbol) {
                const baseData = PROFESSIONAL_MARKET_DATA[symbol];
                if (!baseData) return null;

                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // Professional volatility modeling based on market hours
                let volatility = baseData.volatility;
                const isMarketHours = (hour >= 9 && hour < 15) || (hour === 15 && minute < 30);
                
                if (!isMarketHours) {
                    volatility *= 0.3; // Lower volatility outside market hours
                } else {
                    // Intraday volatility patterns
                    if (hour === 9 && minute < 30) volatility *= 2.5; // Opening volatility
                    else if (hour === 15 && minute > 15) volatility *= 2.0; // Closing volatility
                    else if (hour >= 11 && hour <= 13) volatility *= 0.6; // Lunch time
                    else volatility *= 1.2; // Regular trading hours
                }

                // Generate realistic price movement
                const randomWalk = (Math.random() - 0.5) * 2; // -1 to 1
                const trend = Math.sin(Date.now() / 1000000) * 0.1; // Long-term trend
                const change = (randomWalk * volatility) + (trend * volatility * 0.5);
                
                const currentPrice = baseData.price * (1 + change + (baseData.change / 100 * 0.1));
                const open = baseData.price * (1 + (Math.random() - 0.5) * volatility * 0.5);
                const high = Math.max(currentPrice, open) * (1 + Math.random() * volatility * 0.5);
                const low = Math.min(currentPrice, open) * (1 - Math.random() * volatility * 0.5);
                
                const changePercent = ((currentPrice - baseData.price) / baseData.price) * 100;

                return {
                    symbol: symbol,
                    ltp: parseFloat(currentPrice.toFixed(2)),
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: baseData.price,
                    volume: Math.floor(Math.random() * 3000000) + 500000,
                    change: parseFloat(changePercent.toFixed(2)),
                    timestamp: new Date().toISOString(),
                    isLive: false,
                    isProfessional: true,
                    volatility: volatility
                };
            }
        }

        // Professional Trading Platform
        class ProfessionalTradingPlatform {
            constructor() {
                this.angelService = new ProfessionalAngelOneService();
                this.symbols = ['NIFTY50', 'BANKNIFTY', 'RELIANCE', 'TCS'];
                this.currentSymbol = 'NIFTY50';
                this.priceHistory = new Map();
                this.chartCanvas = null;
                this.chartCtx = null;
                this.chartAnnotations = [];
                this.isInitialized = false;
                this.isProfessionalMode = false;
                this.updateInterval = null;
                
                // Initialize price history
                this.symbols.forEach(symbol => {
                    this.priceHistory.set(symbol, []);
                });
            }

            async initializePlatform(isProfessional, connectionData) {
                try {
                    this.isProfessionalMode = isProfessional;
                    
                    // Update connection status
                    const statusText = isProfessional ? 
                        `Professional Demo - ${connectionData.clientCode}` : 
                        'Professional Trading Platform';
                    
                    document.getElementById('connectionText').textContent = statusText;
                    
                    const statusDot = document.getElementById('connectionDot');
                    statusDot.className = 'status-dot';
                    
                    const statusBadge = document.getElementById('apiStatusBadge');
                    statusBadge.textContent = 'PROFESSIONAL DEMO';
                    statusBadge.className = 'api-status-badge demo';

                    // Initialize chart
                    this.initChart();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Generate initial historical data
                    this.symbols.forEach(symbol => {
                        this.generateProfessionalHistory(symbol);
                    });
                    
                    // Start professional data feeds
                    this.startProfessionalDataFeeds();
                    
                    // Market time updates
                    this.updateMarketTime();
                    setInterval(() => this.updateMarketTime(), 1000);
                    
                    // Update displays
                    this.updateAllDisplays();
                    
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        console.log('ðŸš€ Professional Platform initialized successfully');
                    }, 2000);
                    
                    this.isInitialized = true;
                    
                } catch (error) {
                    console.error('Platform initialization error:', error);
                }
            }

            generateProfessionalHistory(symbol) {
                const history = [];
                const baseData = PROFESSIONAL_MARKET_DATA[symbol];
                const basePrice = baseData?.price || 1000;
                let price = basePrice;

                for (let i = 100; i >= 0; i--) {
                    const timestamp = new Date(Date.now() - i * 60000);
                    const hour = timestamp.getHours();
                    
                    let volatility = baseData?.volatility || 0.001;
                    
                    // Time-based volatility
                    if (hour === 9) volatility *= 2.0;
                    if (hour === 15) volatility *= 1.5;
                    if (hour >= 11 && hour <= 13) volatility *= 0.5;
                    
                    const change = (Math.random() - 0.5) * volatility;
                    price = Math.max(price * (1 + change), basePrice * 0.985);
                    
                    const open = price;
                    const high = price * (1 + Math.random() * volatility);
                    const low = price * (1 - Math.random() * volatility);
                    const close = low + Math.random() * (high - low);
                    
                    history.push({
                        timestamp: timestamp.toISOString(),
                        open: parseFloat(open.toFixed(2)),
                        high: parseFloat(high.toFixed(2)),
                        low: parseFloat(low.toFixed(2)),
                        close: parseFloat(close.toFixed(2)),
                        volume: Math.floor(Math.random() * 1000000) + 200000
                    });
                    
                    price = close;
                }
                
                this.priceHistory.set(symbol, history);
            }

            async startProfessionalDataFeeds() {
                // Initial data fetch
                await this.fetchAndUpdatePrices();

                // Start professional-grade updates every 2 seconds
                this.updateInterval = setInterval(() => this.fetchAndUpdatePrices(), 2000);
            }

            async fetchAndUpdatePrices() {
                try {
                    const professionalData = await this.angelService.fetchProfessionalData(this.symbols);
                    
                    if (professionalData && Array.isArray(professionalData)) {
                        professionalData.forEach((item, index) => {
                            if (item && item.ltp) {
                                const symbol = this.symbols[index];
                                this.updateSymbolPrice(symbol, item.ltp, item);
                                this.addPriceToHistory(symbol, item.ltp, item);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Professional data fetch error:', error);
                }
            }

            updateSymbolPrice(symbol, price, fullData = null) {
                const priceEl = document.getElementById(`price-${symbol}`);
                const changeEl = document.getElementById(`change-${symbol}`);
                
                if (priceEl && changeEl) {
                    const history = this.priceHistory.get(symbol) || [];
                    const previousPrice = history.length > 0 ? history[history.length - 1].close : price;
                    
                    const change = price - previousPrice;
                    const changePercent = (change / previousPrice) * 100;
                    
                    priceEl.textContent = price.toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    const sign = changePercent >= 0 ? '+' : '';
                    changeEl.textContent = `${sign}${changePercent.toFixed(2)}%`;
                    changeEl.className = `symbol-change ${changePercent >= 0 ? 'positive' : 'negative'}`;
                    
                    // Update current price display if this is the selected symbol
                    if (symbol === this.currentSymbol) {
                        document.getElementById('currentPrice').textContent = price.toLocaleString('en-IN');
                        const priceChangeEl = document.getElementById('priceChange');
                        priceChangeEl.textContent = `${sign}${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)`;
                        priceChangeEl.className = `price-change ${changePercent >= 0 ? 'positive' : 'negative'}`;
                        
                        // Update volume with realistic patterns
                        const baseVolume = fullData?.volume || 1000000;
                        const volumeInM = (baseVolume / 1000000).toFixed(1);
                        document.getElementById('volume').textContent = volumeInM + 'M';
                    }
                }
            }

            addPriceToHistory(symbol, price, fullData = null) {
                const history = this.priceHistory.get(symbol) || [];
                const timestamp = new Date().toISOString();
                
                const pricePoint = {
                    timestamp: timestamp,
                    open: fullData?.open || price,
                    high: fullData?.high || price * 1.001,
                    low: fullData?.low || price * 0.999,
                    close: price,
                    volume: fullData?.volume || Math.floor(Math.random() * 1000000) + 500000
                };
                
                history.push(pricePoint);
                
                // Keep only last 200 points for performance
                if (history.length > 200) history.shift();
                
                this.priceHistory.set(symbol, history);
                
                // Update displays if this is the current symbol
                if (symbol === this.currentSymbol) {
                    this.updateChart();
                    this.updateTechnicalIndicators();
                    this.updateMarketDepth();
                }
            }

            initChart() {
                this.chartCanvas = document.getElementById('tradingChart');
                if (!this.chartCanvas) return;
                
                this.chartCtx = this.chartCanvas.getContext('2d');
                const container = this.chartCanvas.parentElement;
                this.chartCanvas.width = container.clientWidth - 40;
                this.chartCanvas.height = container.clientHeight - 40;
                
                this.updateChart();
            }

            updateChart() {
                const history = this.priceHistory.get(this.currentSymbol) || [];
                if (history.length === 0 || !this.chartCtx) return;

                const ctx = this.chartCtx;
                const canvas = this.chartCanvas;
                
                // Clear canvas
                ctx.fillStyle = '#252a3a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const padding = { top: 20, right: 60, bottom: 40, left: 60 };
                const chartWidth = canvas.width - padding.left - padding.right;
                const chartHeight = canvas.height - padding.top - padding.bottom;

                const chartData = history.slice(-60);
                const prices = chartData.map(d => d.close);
                const minPrice = Math.min(...prices) * 0.999;
                const maxPrice = Math.max(...prices) * 1.001;
                const priceRange = maxPrice - minPrice;

                // Store price conversion function
                this.priceToY = (price) => {
                    return padding.top + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
                };

                // Draw professional grid
                ctx.strokeStyle = '#34384a';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(padding.left + chartWidth, y);
                    ctx.stroke();
                }

                // Draw professional price line with gradient
                const spacing = chartWidth / (chartData.length - 1);
                
                // Create gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
                gradient.addColorStop(0, '#00ff88');
                gradient.addColorStop(1, '#00ff8840');
                
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                chartData.forEach((point, index) => {
                    const x = padding.left + (spacing * index);
                    const y = this.priceToY(point.close);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Fill area under the curve
                ctx.fillStyle = gradient;
                ctx.lineTo(padding.left + spacing * (chartData.length - 1), padding.top + chartHeight);
                ctx.lineTo(padding.left, padding.top + chartHeight);
                ctx.closePath();
                ctx.fill();

                // Draw current price dot with animation effect
                if (chartData.length > 0) {
                    const lastPoint = chartData[chartData.length - 1];
                    const lastX = padding.left + spacing * (chartData.length - 1);
                    const lastY = this.priceToY(lastPoint.close);
                    
                    // Outer glow
                    ctx.shadowColor = '#00ff88';
                    ctx.shadowBlur = 10;
                    ctx.fillStyle = '#00ff88';
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Inner dot
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 3, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // Draw professional price axis
                ctx.fillStyle = '#a4a6b3';
                ctx.font = '12px Inter';
                ctx.textAlign = 'left';
                for (let i = 0; i <= 5; i++) {
                    const price = minPrice + (priceRange / 5) * i;
                    const y = padding.top + chartHeight - (chartHeight / 5) * i;
                    ctx.fillText(price.toFixed(2), padding.left + chartWidth + 5, y + 4);
                }

                // Draw professional annotations
                this.drawProfessionalAnnotations(padding, chartWidth, chartHeight);
            }

            drawProfessionalAnnotations(padding, chartWidth, chartHeight) {
                if (this.chartAnnotations.length === 0) return;

                const ctx = this.chartCtx;
                
                this.chartAnnotations.forEach(annotation => {
                    if (annotation.type === 'horizontal_line' && this.priceToY) {
                        const y = this.priceToY(annotation.price);
                        
                        ctx.strokeStyle = annotation.color;
                        ctx.lineWidth = annotation.width || 2;
                        ctx.setLineDash([8, 4]);
                        
                        ctx.beginPath();
                        ctx.moveTo(padding.left, y);
                        ctx.lineTo(padding.left + chartWidth, y);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Professional label with background
                        ctx.fillStyle = annotation.color + '20';
                        ctx.fillRect(padding.left + 10, y - 15, 120, 20);
                        ctx.fillStyle = annotation.color;
                        ctx.font = 'bold 12px Inter';
                        ctx.textAlign = 'left';
                        ctx.fillText(annotation.label, padding.left + 15, y - 2);
                    }
                });
            }

            setupEventListeners() {
                // Symbol selection
                document.querySelectorAll('.symbol-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const symbol = card.dataset.symbol;
                        this.selectSymbol(symbol);
                    });
                });

                // Professional signal generation
                const signalBtn = document.getElementById('generateSignal');
                if (signalBtn) {
                    signalBtn.addEventListener('click', () => {
                        this.generateProfessionalSignal();
                    });
                }
            }

            selectSymbol(symbol) {
                this.currentSymbol = symbol;
                
                // Update active state
                document.querySelectorAll('.symbol-card').forEach(card => {
                    card.classList.remove('active');
                    if (card.dataset.symbol === symbol) {
                        card.classList.add('active');
                    }
                });
                
                // Update chart title
                const displayName = symbol === 'NIFTY50' ? 'NIFTY 50' : 
                                  symbol === 'BANKNIFTY' ? 'BANK NIFTY' : symbol;
                document.getElementById('chart-title').textContent = `${displayName} - Professional Chart`;
                
                // Clear annotations and update displays
                this.chartAnnotations = [];
                this.updateAllDisplays();
            }

            updateAllDisplays() {
                this.updateChart();
                this.updateTechnicalIndicators();
                this.updateMarketDepth();
            }

            updateTechnicalIndicators() {
                const history = this.priceHistory.get(this.currentSymbol) || [];
                if (history.length < 20) return;

                const prices = history.map(h => h.close);
                const rsi = this.calculateRSI(prices);
                const sma20 = this.calculateSMA(prices, 20);
                
                // Update RSI with professional styling
                const rsiEl = document.getElementById('rsi');
                rsiEl.textContent = rsi.toFixed(1);
                rsiEl.className = rsi > 70 ? 'bearish' : rsi < 30 ? 'bullish' : 'neutral';

                // Update SMA
                document.getElementById('sma20').textContent = sma20.toFixed(2);
                
                // Calculate professional support and resistance
                const recentPrices = prices.slice(-50);
                const support = this.calculateSupport(recentPrices);
                const resistance = this.calculateResistance(recentPrices);
                
                document.getElementById('support').textContent = support.toFixed(2);
                document.getElementById('resistance').textContent = resistance.toFixed(2);

                // Update MACD with professional logic
                const macdEl = document.getElementById('macd');
                const currentPrice = prices[prices.length - 1];
                const macdSignal = this.calculateProfessionalMACD(prices);
                macdEl.textContent = macdSignal.signal;
                macdEl.className = macdSignal.signal === 'Bullish' ? 'bullish' : 'bearish';
            }

            calculateSupport(prices) {
                const sortedPrices = [...prices].sort((a, b) => a - b);
                const lowerQuartile = sortedPrices[Math.floor(sortedPrices.length * 0.25)];
                return lowerQuartile * 1.002;
            }

            calculateResistance(prices) {
                const sortedPrices = [...prices].sort((a, b) => b - a);
                const upperQuartile = sortedPrices[Math.floor(sortedPrices.length * 0.25)];
                return upperQuartile * 0.998;
            }

            calculateProfessionalMACD(prices) {
                const ema12 = this.calculateEMA(prices, 12);
                const ema26 = this.calculateEMA(prices, 26);
                
                if (!ema12 || !ema26) return { signal: 'Neutral', value: 0 };
                
                const macdLine = ema12 - ema26;
                const signal = macdLine > 0 ? 'Bullish' : 'Bearish';
                
                return { signal, value: macdLine };
            }

            calculateEMA(prices, period) {
                if (prices.length < period) return null;
                
                const multiplier = 2 / (period + 1);
                let ema = prices.slice(0, period).reduce((sum, price) => sum + price, 0) / period;
                
                for (let i = period; i < prices.length; i++) {
                    ema = (prices[i] * multiplier) + (ema * (1 - multiplier));
                }
                
                return ema;
            }

            updateMarketDepth() {
                const history = this.priceHistory.get(this.currentSymbol) || [];
                if (history.length === 0) return;

                const currentPrice = history[history.length - 1].close;
                const spread = currentPrice * 0.0001;
                
                let depthHtml = '';
                for (let i = 0; i < 5; i++) {
                    const bid = (currentPrice - (spread * (i + 1))).toFixed(2);
                    const ask = (currentPrice + (spread * (i + 1))).toFixed(2);
                    const bidQty = (Math.floor(Math.random() * 8000) + 2000).toLocaleString();
                    const askQty = (Math.floor(Math.random() * 8000) + 2000).toLocaleString();
                    
                    depthHtml += `
                        <div class="depth-row">
                            <span style="color: #00ff88">${bidQty}</span>
                            <span style="color: #00ff88">${bid}</span>
                            <span style="color: #ff4757">${ask}</span>
                            <span style="color: #ff4757">${askQty}</span>
                        </div>
                    `;
                }
                
                document.getElementById('marketDepth').innerHTML = depthHtml;
            }

            calculateRSI(prices, period = 14) {
                if (prices.length < period + 1) return 50;
                
                const gains = [], losses = [];
                for (let i = 1; i < prices.length; i++) {
                    const change = prices[i] - prices[i - 1];
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? Math.abs(change) : 0);
                }
                
                const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                
                return avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
            }

            calculateSMA(prices, period) {
                if (prices.length < period) return prices[prices.length - 1];
                return prices.slice(-period).reduce((a, b) => a + b, 0) / period;
            }

            async generateProfessionalSignal() {
                const btn = document.getElementById('generateSignal');
                const originalText = btn.textContent;
                
                btn.textContent = 'Analyzing Professional Data...';
                btn.disabled = true;
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 2500));
                    
                    const history = this.priceHistory.get(this.currentSymbol) || [];
                    if (history.length < 20) {
                        throw new Error('Insufficient historical data for professional analysis');
                    }

                    const prices = history.map(h => h.close);
                    const volumes = history.map(h => h.volume);
                    const currentPrice = prices[prices.length - 1];
                    const rsi = this.calculateRSI(prices);
                    const sma20 = this.calculateSMA(prices, 20);
                    const sma50 = this.calculateSMA(prices, 50);
                    const ema12 = this.calculateEMA(prices, 12);
                    const ema26 = this.calculateEMA(prices, 26);
                    
                    // Professional signal generation with multiple indicators
                    let signal = 'HOLD', confidence = 65;
                    let bullishPoints = 0, bearishPoints = 0;
                    const reasons = [];
                    
                    // Price action analysis
                    if (currentPrice > sma20 && sma20 > sma50) {
                        bullishPoints += 3;
                        reasons.push('Strong uptrend confirmed by moving averages');
                    } else if (currentPrice < sma20 && sma20 < sma50) {
                        bearishPoints += 3;
                        reasons.push('Downtrend confirmed by moving averages');
                    }
                    
                    // RSI analysis
                    if (rsi < 25) {
                        bullishPoints += 4;
                        reasons.push('RSI indicates oversold conditions');
                    } else if (rsi > 75) {
                        bearishPoints += 4;
                        reasons.push('RSI indicates overbought conditions');
                    } else if (rsi > 55) {
                        bullishPoints += 1;
                        reasons.push('RSI shows bullish momentum');
                    } else if (rsi < 45) {
                        bearishPoints += 1;
                        reasons.push('RSI shows bearish momentum');
                    }
                    
                    // MACD analysis
                    if (ema12 && ema26) {
                        const macdLine = ema12 - ema26;
                        if (macdLine > 0) {
                            bullishPoints += 2;
                            reasons.push('MACD shows bullish crossover');
                        } else {
                            bearishPoints += 2;
                            reasons.push('MACD shows bearish crossover');
                        }
                    }
                    
                    // Volume analysis
                    const recentVolume = volumes.slice(-5).reduce((sum, v) => sum + v, 0) / 5;
                    const avgVolume = volumes.slice(-20).reduce((sum, v) => sum + v, 0) / 20;
                    if (recentVolume > avgVolume * 1.3) {
                        if (bullishPoints > bearishPoints) {
                            bullishPoints += 2;
                            reasons.push('High volume supports bullish move');
                        } else {
                            bearishPoints += 2;
                            reasons.push('High volume supports bearish move');
                        }
                    }
                    
                    // Professional signal determination
                    if (bullishPoints > bearishPoints + 3) {
                        signal = 'BUY';
                        confidence = Math.min(75 + (bullishPoints - bearishPoints) * 3, 95);
                    } else if (bearishPoints > bullishPoints + 3) {
                        signal = 'SELL';
                        confidence = Math.min(75 + (bearishPoints - bullishPoints) * 3, 95);
                    }

                    // Calculate professional trade levels
                    const atr = this.calculateATR(history.slice(-14)); // Average True Range
                    const entry = signal === 'BUY' ? currentPrice * 1.001 : 
                                  signal === 'SELL' ? currentPrice * 0.999 : currentPrice;
                    const stopLoss = signal === 'BUY' ? currentPrice - (atr * 2) : 
                                     signal === 'SELL' ? currentPrice + (atr * 2) : currentPrice - (atr * 1);
                    const target1 = signal === 'BUY' ? currentPrice + (atr * 3) : 
                                    signal === 'SELL' ? currentPrice - (atr * 3) : currentPrice + (atr * 1.5);
                    const target2 = signal === 'BUY' ? currentPrice + (atr * 5) : 
                                    signal === 'SELL' ? currentPrice - (atr * 5) : currentPrice + (atr * 2.5);
                    
                    // Add professional chart annotations
                    this.addProfessionalAnnotations(entry, stopLoss, target1, signal, confidence);
                    
                    // Generate professional options strategy
                    const optionsStrategy = this.generateProfessionalOptionsStrategy(signal, currentPrice, atr);
                    
                    // Display professional signal
                    this.displayProfessionalSignal(signal, confidence, entry, stopLoss, target1, target2, optionsStrategy, rsi, sma20, reasons);
                    
                } catch (error) {
                    console.error('Professional signal generation error:', error);
                    document.getElementById('signalResult').innerHTML = `
                        <div style="color: #ff4757; padding: 15px; background: rgba(255, 71, 87, 0.1); border-radius: 8px;">
                            <strong>Error:</strong> ${error.message}
                        </div>
                    `;
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            calculateATR(history, period = 14) {
                if (history.length < period) return history[history.length - 1].close * 0.01;
                
                const trueRanges = history.slice(-period).map((candle, index) => {
                    if (index === 0) return candle.high - candle.low;
                    
                    const prevClose = history[history.length - period + index - 1].close;
                    return Math.max(
                        candle.high - candle.low,
                        Math.abs(candle.high - prevClose),
                        Math.abs(candle.low - prevClose)
                    );
                });
                
                return trueRanges.reduce((sum, tr) => sum + tr, 0) / period;
            }

            addProfessionalAnnotations(entry, stopLoss, target, signal, confidence) {
                this.chartAnnotations = [
                    {
                        type: 'horizontal_line',
                        price: entry,
                        color: '#00ff88',
                        label: `ENTRY: â‚¹${entry.toFixed(2)}`,
                        width: 3
                    },
                    {
                        type: 'horizontal_line',
                        price: stopLoss,
                        color: '#ff4757',
                        label: `STOP: â‚¹${stopLoss.toFixed(2)}`,
                        width: 3
                    },
                    {
                        type: 'horizontal_line',
                        price: target,
                        color: '#4caf50',
                        label: `TARGET: â‚¹${target.toFixed(2)}`,
                        width: 2
                    }
                ];
                
                this.updateChart();
            }

            generateProfessionalOptionsStrategy(signal, currentPrice, atr) {
                const atmStrike = Math.round(currentPrice / 50) * 50;
                const expiry = this.getNextExpiry();
                const impliedVol = Math.min(Math.max(atr / currentPrice * 100, 15), 40);
                
                if (signal === 'BUY') {
                    const premium = (currentPrice * (impliedVol / 100) * 0.3).toFixed(2);
                    return {
                        name: 'Long Call Strategy',
                        type: 'BULLISH',
                        action: 'BUY',
                        option: 'CALL',
                        strike: atmStrike,
                        expiry: expiry,
                        premium: parseFloat(premium),
                        maxLoss: parseFloat(premium),
                        breakeven: atmStrike + parseFloat(premium),
                        impliedVol: impliedVol.toFixed(1)
                    };
                } else if (signal === 'SELL') {
                    const premium = (currentPrice * (impliedVol / 100) * 0.28).toFixed(2);
                    return {
                        name: 'Long Put Strategy',
                        type: 'BEARISH',
                        action: 'BUY',
                        option: 'PUT',
                        strike: atmStrike,
                        expiry: expiry,
                        premium: parseFloat(premium),
                        maxLoss: parseFloat(premium),
                        breakeven: atmStrike - parseFloat(premium),
                        impliedVol: impliedVol.toFixed(1)
                    };
                } else {
                    return {
                        name: 'Iron Condor Strategy',
                        type: 'NEUTRAL',
                        recommendation: 'Range-bound market - collect premium',
                        impliedVol: impliedVol.toFixed(1)
                    };
                }
            }

            getNextExpiry() {
                const now = new Date();
                const nextThursday = new Date(now);
                const daysToThursday = (4 - now.getDay() + 7) % 7;
                nextThursday.setDate(now.getDate() + (daysToThursday || 7));
                
                return nextThursday.toLocaleDateString('en-IN', { 
                    day: '2-digit', month: 'short', year: 'numeric' 
                });
            }

            displayProfessionalSignal(signal, confidence, entry, stopLoss, target1, target2, options, rsi, sma20, reasons) {
                const signalColor = signal === 'BUY' ? '#00ff88' : signal === 'SELL' ? '#ff4757' : '#ffd700';
                const displaySymbol = this.currentSymbol === 'NIFTY50' ? 'NIFTY 50' : 
                                   this.currentSymbol === 'BANKNIFTY' ? 'BANK NIFTY' : this.currentSymbol;
                
                const riskReward = Math.abs(target1 - entry) / Math.abs(entry - stopLoss);
                
                document.getElementById('signalResult').innerHTML = `
                    <div class="professional-signal">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="color: ${signalColor}; font-size: 20px; font-weight: 700;">
                                ${signal} SIGNAL - ${displaySymbol}
                            </h4>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #a4a6b3;">Professional Confidence</div>
                                <div style="font-size: 28px; font-weight: bold; color: ${signalColor};">${confidence}%</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                            <div style="text-align: center; padding: 18px; background: rgba(0,255,136,0.15); border-radius: 10px; border: 2px solid #00ff88;">
                                <div style="color: #888; font-size: 12px; font-weight: 600;">ENTRY PRICE</div>
                                <div style="font-size: 20px; font-weight: bold; color: #00ff88;">â‚¹${entry.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 18px; background: rgba(255,71,87,0.15); border-radius: 10px; border: 2px solid #ff4757;">
                                <div style="color: #888; font-size: 12px; font-weight: 600;">STOP LOSS</div>
                                <div style="font-size: 20px; font-weight: bold; color: #ff4757;">â‚¹${stopLoss.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 18px; background: rgba(76,175,80,0.15); border-radius: 10px; border: 2px solid #4caf50;">
                                <div style="color: #888; font-size: 12px; font-weight: 600;">TARGET 1</div>
                                <div style="font-size: 20px; font-weight: bold; color: #4caf50;">â‚¹${target1.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="options-recommendation">
                            <h4 style="color: #3742fa; margin-bottom: 15px; font-size: 16px;">ðŸŽ¯ Professional Options Strategy</h4>
                            <div style="background: rgba(55, 66, 250, 0.15); padding: 18px; border-radius: 10px; border: 1px solid #3742fa;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-weight: 700; color: ${signalColor}; font-size: 18px;">${options.name}</span>
                                    <span style="background: ${signalColor}; color: black; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;">${options.type}</span>
                                </div>
                                <div style="font-size: 15px; margin-bottom: 12px; font-weight: 600;">
                                    <strong>${options.action} ${displaySymbol} ${options.strike} ${options.option}</strong>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 13px;">
                                    <div><strong>Premium:</strong> â‚¹${options.premium}</div>
                                    <div><strong>Expiry:</strong> ${options.expiry}</div>
                                    <div><strong>Max Loss:</strong> â‚¹${options.maxLoss}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px; margin-top: 8px;">
                                    <div><strong>Breakeven:</strong> â‚¹${options.breakeven.toFixed(2)}</div>
                                    <div><strong>Implied Vol:</strong> ${options.impliedVol}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.08); padding: 18px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="color: ${signalColor}; margin-bottom: 12px; font-size: 16px;">ðŸ“Š Professional Analysis Summary</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 13px; margin-bottom: 15px;">
                                <div><strong>RSI:</strong> ${rsi.toFixed(1)} ${rsi > 70 ? '(Overbought)' : rsi < 30 ? '(Oversold)' : '(Neutral)'}</div>
                                <div><strong>SMA20:</strong> â‚¹${sma20.toFixed(2)}</div>
                                <div><strong>Risk/Reward:</strong> 1:${riskReward.toFixed(1)}</div>
                            </div>
                            <div style="font-size: 13px;">
                                <strong>Key Factors:</strong>
                                <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                                    ${reasons.map(reason => `<li>${reason}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,255,136,0.12); padding: 18px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="margin-bottom: 12px; font-size: 16px;">ðŸš€ Professional Execution Plan</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h5 style="color: #00ff88; margin-bottom: 8px;">Cash Market</h5>
                                    <ul style="margin-left: 20px; font-size: 12px; color: #a4a6b3; line-height: 1.6;">
                                        <li>Entry at â‚¹${entry.toFixed(2)} (GREEN line)</li>
                                        <li>Stop Loss at â‚¹${stopLoss.toFixed(2)} (RED line)</li>
                                        <li>Target 1 at â‚¹${target1.toFixed(2)}</li>
                                        <li>Target 2 at â‚¹${target2.toFixed(2)}</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 style="color: #3742fa; margin-bottom: 8px;">Options Strategy</h5>
                                    <ul style="margin-left: 20px; font-size: 12px; color: #a4a6b3; line-height: 1.6;">
                                        <li>Execute ${options.name}</li>
                                        <li>Strike: ${options.strike}</li>
                                        <li>Premium: â‚¹${options.premium}</li>
                                        <li>Monitor implied volatility</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: 11px; color: #666; text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #34384a;">
                            ðŸŸ¢ PROFESSIONAL DEMO MODE â€¢ Chart displays colored entry/exit lines â€¢ Based on advanced technical analysis
                        </div>
                    </div>
                `;
            }

            updateMarketTime() {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const isMarketOpen = (hour >= 9 && hour < 15) || (hour === 15 && minute < 30);
                
                const timeStr = now.toLocaleTimeString('en-IN', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                document.getElementById('market-time').textContent = 
                    `NSE: ${isMarketOpen ? 'OPEN' : 'CLOSED'} | ${timeStr}`;
            }

            // Cleanup method
            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            }
        }

        // Global functions for modal interactions
        let professionalPlatform = null;
        let angelService = new ProfessionalAngelOneService();

        async function connectWithAdvancedAuth() {
            const clientCode = document.getElementById('clientCode').value.trim();
            const totp = document.getElementById('totp').value.trim();
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');
            const connectBtn = document.getElementById('connectBtn');
            
            // Clear previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            connectBtn.textContent = 'Connecting...';
            connectBtn.disabled = true;

            try {
                const result = await angelService.authenticateAdvanced(clientCode, totp);
                
                if (result.success) {
                    // This won't happen due to CORS, but keeping for future backend integration
                    successDiv.innerHTML = `<strong>Success:</strong> ${result.message}`;
                    successDiv.style.display = 'block';
                    await initializeProfessionalPlatform(true, result.data);
                } else {
                    // Professional demo mode
                    if (result.isDemo) {
                        console.log('ðŸŽ­ Activating Professional Demo Mode');
                        successDiv.innerHTML = `<strong>Professional Demo:</strong> ${result.message}`;
                        successDiv.style.display = 'block';
                        
                        setTimeout(() => {
                            initializeProfessionalPlatform(false, result.data);
                        }, 2000);
                    } else {
                        throw new Error(result.message);
                    }
                }
                
            } catch (error) {
                console.error('ðŸ”¥ Advanced authentication error:', error);
                errorDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                errorDiv.style.display = 'block';
                
                connectBtn.textContent = 'Connect to Live Data';
                connectBtn.disabled = false;
            }
        }

        async function useProfessionalDemo() {
            console.log('ðŸŽ­ User selected Professional Demo Mode');
            await initializeProfessionalPlatform(false, { 
                demoMode: 'professional', 
                isLive: false,
                clientCode: 'DEMO_USER'
            });
        }

        async function initializeProfessionalPlatform(isLive, connectionData) {
            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                document.getElementById('apiConfigModal').classList.add('hidden');
                
                // Initialize professional platform
                professionalPlatform = new ProfessionalTradingPlatform();
                await professionalPlatform.initializePlatform(isLive, connectionData);
                
            } catch (error) {
                console.error('Professional platform initialization error:', error);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ Doravaru Professional Trading Platform Starting...');
            
            // Auto-focus on TOTP input
            setTimeout(() => {
                const totpInput = document.getElementById('totp');
                if (totpInput) totpInput.focus();
            }, 500);
            
            // Auto-submit on Enter key
            const totpInput = document.getElementById('totp');
            if (totpInput) {
                totpInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && totpInput.value.length === 6) {
                        connectWithAdvancedAuth();
                    }
                });

                // Auto-format TOTP input
                totpInput.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\D/g, '');
                    e.target.value = value.substring(0, 6);
                });
            }

            // Handle window resize for chart
            window.addEventListener('resize', () => {
                if (professionalPlatform && professionalPlatform.initChart) {
                    setTimeout(() => professionalPlatform.initChart(), 100);
                }
            });

            // Professional keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (professionalPlatform && professionalPlatform.isInitialized) {
                    // Switch symbols with number keys
                    if (e.key === '1') professionalPlatform.selectSymbol('NIFTY50');
                    if (e.key === '2') professionalPlatform.selectSymbol('BANKNIFTY');
                    if (e.key === '3') professionalPlatform.selectSymbol('RELIANCE');
                    if (e.key === '4') professionalPlatform.selectSymbol('TCS');
                    
                    // Generate signal with 'S' key
                    if (e.key === 's' || e.key === 'S') {
                        professionalPlatform.generateProfessionalSignal();
                    }
                    
                    // Refresh data with 'R' key
                    if (e.key === 'r' || e.key === 'R') {
                        professionalPlatform.fetchAndUpdatePrices();
                    }
                }
            });

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (professionalPlatform) {
                    professionalPlatform.destroy();
                }
            });
        });

        // Professional error handlers
        window.addEventListener('error', (event) => {
            console.error('Professional platform error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Export for debugging and extensions
        window.professionalPlatform = professionalPlatform;
        window.angelService = angelService;
        window.PROFESSIONAL_MARKET_DATA = PROFESSIONAL_MARKET_DATA;

        console.log('ðŸŽ¯ Doravaru Professional Trading Platform Loaded');
        console.log('ðŸ“Š Features: Professional Demo Mode, Advanced Charts, Options Strategies, Technical Analysis');
        console.log('âŒ¨ï¸ Shortcuts: 1-4 (Symbols), S (Signal), R (Refresh)');
        console.log('ðŸ”§ Note: Due to browser CORS restrictions, professional demo mode provides realistic market simulation');
    </script>
</body>
</html>